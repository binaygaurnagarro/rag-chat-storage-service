
# RAG Chat Storage Microservice

A production-ready Spring Boot microservice to store and retrieve chat conversations generated by a Retrieval-Augmented Generation (RAG) chatbot system.

This service securely stores:
- User sessions
- Chat messages
- Retrieved context metadata
- Pagination support
- Bucket4j based rate limiting

---

# Tech Stack

- Java 21
- Spring Boot 3
- Spring Data JPA
- Postgress
- Bucket4j (for rate limiting)
- Lombok
- Swagger / OpenAPI
- Docker & Docker Compose

---

## Features

- Create and manage chat sessions
- Store chat messages with optional retrieved context
- Rename sessions
- Mark sessions as favorite
- Delete sessions with cascade delete
- Pagination support for messages
- API Key based authentication
- Rate limiting
- Centralized error handling and logging
- Health check endpoint

---

## API Authentication

All APIs require the following header:
- 'X-API-KEY: secret-key'

---

# Project Structure

```

rag-chat-storage-service/
├── config/
├── controller/
├── service/
├── service/impl/
├── repository/
├── entity/
├── dto/
├── exception/
├── application.yml
├── docker-compose.yml
├── Dockerfile
├── .env.example
└── README.md

````

---

# Setup and Running Instructions

## 1️. Clone Repository

```bash
git clone https://github.com/binaygaurnagarro/rag-chat-storage-service.git
cd rag-chat-storage-service
````

---

## 2️. Configure Environment Variables

Update `application.yml`:

```yaml
security:
  api-key: ${API_KEY}
spring:
    datasource:
		url: ${DB_URL}
		username: ${DB_USERNAME}
		password: ${DB_PASSWORD}
		driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
```

---

## 3️. Start Postgress & Redis (Docker Recommended)

```bash
docker-compose up -d
```

Example `docker-compose.yml`:

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    env_file: .env
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: chatdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
```

---

## 4️. Run the Application

Using Maven:

```bash
mvn clean install
mvn spring-boot:run
```

Or run directly from your IDE.

Application will start at:

```
http://localhost:8080
```

---

# Rate Limiting

* Implemented using Bucket4j
* Limit: 10 requests per minute per API key
* Required Header: `X-API-KEY`

If limit is exceeded:

```
HTTP 429 Too Many Requests
```

Headers returned:

```
X-RateLimit-Limit
X-RateLimit-Remaining
Retry-After
```

---

#  Available APIs

Base URL:

```
http://localhost:8080/chat/v1/api/
```

---

## 1️. Create Session

**POST** `/sessions`

Request Body:

```json
{
    "userId": "user1",
    "name": "session5"
}
```

Response:

```
201 Created
```

---

## 2️. Get Sessions By User (Paginated)

**GET** `/sessions?userId=user2&page=0&size=10`

Response:

```json
{
    "content": [
        {
            "id": 6,
            "name": "session6",
            "userId": "user2",
            "favorite": false,
            "createdAt": "2026-02-18T17:28:14.123729Z",
            "updatedAt": "2026-02-18T17:28:14.123729Z"
        }
    ],
    "pageable": {
        "pageNumber": 0,
        "pageSize": 5,
        "sort": {
            "empty": false,
            "sorted": true,
            "unsorted": false
        },
        "offset": 0,
        "paged": true,
        "unpaged": false
    },
    "last": true,
    "totalElements": 1,
    "totalPages": 1,
    "first": true,
    "size": 5,
    "number": 0,
    "sort": {
        "empty": false,
        "sorted": true,
        "unsorted": false
    },
    "numberOfElements": 1,
    "empty": false
}
```

---

## 3️. Rename the session Session

**PUT** `/sessions/{sessionId}

Request:

```json
{
    "name": "session"
}
```

Response:

```
200 Ok
```

---

## 4. Mark Session as favorite

**PUT** `/sessions/{sessionId}?value=true`

Response:

```
200 Ok
```

---


## 5. Delete session and associated messages with session

**DELETE** `/sessions/{sessionId}`

Response:

```
204 No Content
```

---

## 6. Add Message To Session

**POST** `/sessions/{sessionId}/messages`

Request:

```json
{
    "sender": "AI",
    "message": "What is RAG?"
}
```

Response:

```
201 Created
```

---

## 7. Get Messages By Session (Paginated)

**GET** `/sessions/{sessionId}/messages?page=0&size=10`

Response:

```json
{
    "content": [
        {
            "id": 6,
            "sender": "USER",
            "message": "What is spring boot?",
            "context": {
                "key1": "value1",
                "key2": 123
            },
            "createdAt": "2026-02-18T14:15:38.647920Z"
        },
        {
            "id": 7,
            "sender": "AI",
            "message": "Spring boot is java framwework to make prouduction ready application",
            "context": {
                "key1": "value1",
                "key2": 123
            },
            "createdAt": "2026-02-18T14:16:21.679634Z"
        }
    ],
    "pageable": {
        "pageNumber": 0,
        "pageSize": 5,
        "sort": {
            "empty": false,
            "unsorted": false,
            "sorted": true
        },
        "offset": 0,
        "unpaged": false,
        "paged": true
    },
    "totalPages": 1,
    "totalElements": 2,
    "last": true,
    "size": 5,
    "number": 0,
    "sort": {
        "empty": false,
        "unsorted": false,
        "sorted": true
    },
    "first": true,
    "numberOfElements": 2,
    "empty": false
}
```

---

# API Documentation (Swagger)

If Swagger is enabled, access:

```
http://localhost:8080/chat/swagger-ui/index.html
```

OpenAPI JSON:

```
http://localhost:8080/chat/v3/api-docs
```

---

# Running Tests

```bash
mvn test
```

Tests include:

* Controller layer tests (MockMvc)
* Service layer tests
* Rate limit tests

---

# Design Decisions

* RESTful API design
* Pagination for scalability
* DTO separation from Entity
* Global exception handling
* Bucket4j rate limiting
* Production-ready error responses

---

# Security Considerations

* API key-based rate limiting
* Input validation using `@Valid`
* Proper HTTP status codes
* Centralized exception handling

---

# Author

Binay Gaur
Backend Developer

```
```
